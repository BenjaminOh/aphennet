services:

    # Next.js (Web)
    react-app:
        container_name: aphennet_web_${COLOR:-blue}
        build:
            context: ./fe
            dockerfile: Dockerfile
            target: production
            args:
                NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL_PROD:-https://api.aphen.net}
                NEXT_PUBLIC_SITE_ID: ${NEXT_PUBLIC_SITE_ID:-aphennet}
                NEXT_PUBLIC_MAINT_NAME: ${NEXT_PUBLIC_MAINT_NAME:-Aphennet}
                NEXT_PUBLIC_ENCRYPTION_KEY: ${NEXT_PUBLIC_ENCRYPTION_KEY:-your_encryption_key}
        restart: always
        ports:
            - "${WEB_PORT:-3000}:3000"
        environment:
            - NODE_ENV=production
            - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL_PROD:-https://api.aphen.net}
            - TZ=Asia/Seoul
        env_file:
            - ./.env
        networks:
            - app-network
        deploy:
            resources:
                limits:
                    memory: 1G
                    cpus: "2.0"
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "3"

    # Node.js (API)
    node-app:
        container_name: aphennet_api_${COLOR:-blue}
        build:
            context: ./be
            dockerfile: Dockerfile
            target: production
        restart: always
        ports:
            - "${API_PORT:-3001}:3000"
        environment:
            - NODE_ENV=production
            - TZ=Asia/Seoul
            - NODE_OPTIONS=--max-old-space-size=800
        env_file:
            - ./.env
        networks:
            - app-network
        healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
            interval: 60s
            timeout: 10s
            retries: 3
            start_period: 60s
        volumes:
            - ./be/upload:/app/upload
            - ./be/storage:/app/storage
        deploy:
            resources:
                limits:
                    memory: 1G
                    cpus: "2.0"
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "3"

networks:
    app-network:
        external: true
